<!DOCTYPE html><html><head><meta charset="utf-8"><title>Markdown Plus exported HTML</title><link rel="stylesheet" href="https://unpkg.com/markdown-core@1.1.0/dist/index.bundle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/mermaid/6.0.0/mermaid.css"></head><body><article class="markdown-body"><h1 id="attention" data-source-line="1"><a class="anchor" href="#attention"><span class="octicon octicon-link"></span></a><strong><em>ATTENTION</em></strong></h1>
<h2 id="아래-코드는-br2023년-02월-02일-한국유전체학회-동계워크샵에서-실시하는brshotgun-metagenomics-분석-실습-수업을-위해-준비한-것입니다-br" data-source-line="3"><a class="anchor" href="#아래-코드는-br2023년-02월-02일-한국유전체학회-동계워크샵에서-실시하는brshotgun-metagenomics-분석-실습-수업을-위해-준비한-것입니다-br"><span class="octicon octicon-link"></span></a>아래 코드는 <br>
2023년 02월 02일 한국유전체학회 동계워크샵에서 실시하는<br>
Shotgun Metagenomics 분석 실습 수업을 위해 준비한 것입니다. <br></h2>
<p data-source-line="7">강의자료 제작: <span style="color:blue">성균관대학교 삼성융합의과학원/강북삼성병원 <strong>김한나</strong></span> (문의: <a href="mailto:147942@hanmail.net">147942@hanmail.net</a>)</p>
<hr>
<hr>
<p data-source-line="13">파란 글씨는 클릭이 가능하며, <strong>오른쪽 클릭으로 새창으로 열기</strong>로 여시면, 해당 웹페이지로 연결됩니다. Github 에서 코드를 Copy&amp;Paste 하여 진행하며, 차후 다시보려면 html 파일을 사파리나 <a href="https://www.google.com/intl/ko/chrome/">크롬브라우저</a>를 이용하기 바랍니다.</p>
<h2 id="download-실습파일-kogo_winter" data-source-line="16"><a class="anchor" href="#download-실습파일-kogo_winter"><span class="octicon octicon-link"></span></a>Download 실습파일: KOGO_winter</h2>
<ul data-source-line="17">
<li>
<p>실습에 사용할 PC의 OS 확인</p>
<ul>
<li>
<h4 id="window-64bit"><a class="anchor" href="#window-64bit"><span class="octicon octicon-link"></span></a>Window (64bit)</h4>
</li>
<li>Mac (Intel 또는 M1 chip)</li>
<li>
<h4 id="linux"><a class="anchor" href="#linux"><span class="octicon octicon-link"></span></a>Linux</h4>
</li>
</ul>
</li>
<li>
<p>실습 파일 (이메일로 사전 안내된 구글드라이브 링크로 다운로드)</p>
</li>
<li>
<p>압축파일 통째로 <strong>바탕화면</strong> 에 다운로드 후, 바탕화면에서 압축을 푸세요.</p>
</li>
</ul>
<p data-source-line="25"><strong>본 실습파일은 말 그대로 실습용으로서, 실제 연구나 논문작성 등에 사용할 수 없으며, 차후 연구자의 실제 연구 데이터로 본 메뉴얼을 참고하여 분석 시 활용할 수 있으나, 프로그램이나 DB의 업데이트에 따라 일부 명령어가 달라질 수 있습니다.</strong></p>
<hr>
<h2 id="contents" data-source-line="29"><a class="anchor" href="#contents"><span class="octicon octicon-link"></span></a>Contents</h2>
<ul data-source-line="32">
<li>
<p><a href="#raw-data-processing-qcfitering">Raw data processing: QC/Fitering</a></p>
<ul>
<li><a href="#1-raw-data-fastq-quality-%ED%99%95%EC%9D%B8">1. Raw data (fastq) quality 확인</a></li>
<li><a href="#2-quality-filtering">2. Quality Filtering</a></li>
<li><a href="#3-removal-of-unwanted-reads-human-%EC%8B%9C%ED%80%80%EC%8A%A4-%EC%A0%9C%EA%B1%B0">3. Removal of unwanted reads (Human 시퀀스 제거)</a>)</li>
</ul>
</li>
<li>
<p><a href="#taxonomic-functional-profiling">Taxonomic &amp; Functional Profiling</a></p>
<ul>
<li><a href="#1-taxonomic-profiling">1. Taxonomic Profiling</a></li>
<li><a href="#2-functional-profiling">2. Functiona Profiling</a></li>
</ul>
</li>
</ul>
<br>
<h1 id="raw-data-processing-qcfitering" data-source-line="44"><a class="anchor" href="#raw-data-processing-qcfitering"><span class="octicon octicon-link"></span></a>Raw data processing: QC/Fitering</h1>
<h3 id="1-raw-data-fastq-quality-확인" data-source-line="45"><a class="anchor" href="#1-raw-data-fastq-quality-확인"><span class="octicon octicon-link"></span></a>1. Raw data (fastq) quality 확인</h3>
<h4 id="-tool-fastqc-이용" data-source-line="46"><a class="anchor" href="#-tool-fastqc-이용"><span class="octicon octicon-link"></span></a>- Tool: <a href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/">FastQC</a> 이용</h4>
<hr>
<ul data-source-line="48">
<li>작업폴더 (KOGO_workshop)로 이동</li>
</ul>
<pre><code class="hljs"><span class="hljs-built_in">cd</span> /mnt/c/Users/윈도우사용자계정/Desktop/KOGO_winter    <span class="hljs-comment"># 항상 이 위치를 기억하고, 길을 잃었을땐, 이 위치로 돌아오세요.</span>

<span class="hljs-comment"># 또는 외장하드나 파티션 드라이브에 KOGO_winter 폴더를 저장한 경우에는,</span>

<span class="hljs-built_in">cd</span> /mnt/e/KOGO_winter    <span class="hljs-comment"># 이 위치로 늘 돌아오세요 (E: 드라이브일 경우, 소문자 e, D: 나 F: 드라이브도, d, f 등의 소문자를 사용하세요)</span></code></pre><pre><code class="hljs"><span class="hljs-built_in">cd</span> ./Inputs</code></pre><pre><code class="hljs">ls</code></pre><ul data-source-line="62">
<li>총 4명(M1, M2, F1, F2)의 paired-end fastq 파일 4세트
<ul>
<li>각 1만 reads 시퀀스 데이터</li>
</ul>
<pre><code>├── Inputs
    ├── F1_10Krc_1.fastq.gz
    ├── F1_10Krc_2.fastq.gz
    ├── F2_10Krc_1.fastq.gz
    ├── F2_10Krc_2.fastq.gz
    ├── M1_10Krc_1.fastq.gz
    ├── M1_10Krc_2.fastq.gz
    ├── M2_10Krc_1.fastq.gz
    ├── M2_10Krc_2.fastq.gz  
</code></pre>
</li>
<li>Fastq 파일 하나를 구경해봅시다</li>
</ul>
<pre><code class="hljs">gzip -dc M2_10Krc_2.fastq.gz | less -S     <span class="hljs-comment"># q 를 입력해서 빠져나옵니다.</span></code></pre><ul data-source-line="79">
<li>M2_10Krc_2.fastq.gz 1개 파일만 돌려보기</li>
<li><code>cd ../</code> 를 사용하여 한단계 위 폴더(KOGO_winter 폴더)위치로 이동</li>
</ul>
<pre><code class="hljs">./Win_tools/FastQC/fastqc \
./Inputs/M2_10Krc_2.fastq.gz \
-o ./my_results/</code></pre><ul data-source-line="87">
<li>
<p>FastQC 결과파일</p>
<ul>
<li>html 파일 1개에 모든 QC 결과가 저장됨</li>
<li>Basic Statistics: 시퀀스에 대한 기본적인 통계</li>
<li>Per base sequence quality: read 의 각 base position 이 가지는 평균 quality score
<ul>
<li>Warning: 어떤 base의 low quartile 이 &lt;10 일때, 또는 median 이 &lt;25 일때</li>
<li>Failure: low quartile &lt;5 또는 median &lt;20</li>
</ul>
</li>
<li>Per title sequence quality</li>
<li>Per sequence quality scores: 각 reads 가 가지는 평균 quality score 의 분포도
<ul>
<li>Warning: mean quality &lt;27</li>
<li>Failure: mean quality &lt;20</li>
</ul>
</li>
<li>Per base sequence contents: ATGC 구성차이가 &gt;10% 일때 Warning, 20% 일때 Failure
<ul>
<li>일부 구간에서 Failure 라면, library contamination (overrepresented sequence)등을 의심</li>
<li>전 구간에서 일관된 bias: original library 시퀀스 문제이거나 시퀀싱동안 systematic 문제가 있는 것으로 의심</li>
</ul>
</li>
<li>Per sequence GC content</li>
<li>Per base N content: N 으로 calling된 base 의 %</li>
<li>Sequence Length Distribution</li>
<li>Sequence Duplication Levels</li>
<li>Overrepresented sequences: 예상되는 것보다 많이 관측되는 특정 sequence</li>
<li>Adapter Content: 시퀀스에 adapter 시퀀스가 포함되어 있는지 확인</li>
</ul>
</li>
<li>
<p>FastQC 프로그램은 Java 기반으로 만들어져있으므로, 아이콘을 더블클릭해도 실행 가능하나, 여러파일을 동시에 실행하기 위해서는 터미널 이용이 효율적</p>
</li>
<li>
<p>8개의 input files 의 Fastqc 결과</p>
<ul>
<li>Outputs 폴더 &gt; 01_fastqc 폴더에 결과 저장</li>
<li>윈도우탐색기로 확인하세요.</li>
<li>실습에 사용한 fastq 파일은, 짧은시간의 실습진행을 위해, 작은 사이즈로 임의로 만들어진 파일이므로, Qaultiy 에 대한 판단은 불가능하다는 것을 참고하여 보시길 바랍니다.</li>
</ul>
</li>
</ul>
<pre><code class="hljs">├── Outputs
    ├── 01_fastqc
        ├── F1_10Krc_1_fastqc.html
        ├── F1_10Krc_1_fastqc.zip
        ├── F1_10Krc_2_fastqc.html
        ├── F1_10Krc_2_fastqc.zip
        ├── F2_10Krc_1_fastqc.html
        ├── F2_10Krc_1_fastqc.zip
        ├── F2_10Krc_2_fastqc.html
        ├── F2_10Krc_2_fastqc.zip
        ├── M1_10Krc_1_fastqc.html
        ├── M1_10Krc_1_fastqc.zip
        ├── M1_10Krc_2_fastqc.html
        ├── M1_10Krc_2_fastqc.zip
        ├── M2_10Krc_1_fastqc.html
        ├── M2_10Krc_1_fastqc.zip
        ├── M2_10Krc_2_fastqc.html
        ├── M2_10Krc_2_fastqc.zip</code></pre><br>
<h3 id="2-quality-filtering" data-source-line="135"><a class="anchor" href="#2-quality-filtering"><span class="octicon octicon-link"></span></a>2. Quality Filtering</h3>
<h4 id="-tool-trimmomatic-이용" data-source-line="137"><a class="anchor" href="#-tool-trimmomatic-이용"><span class="octicon octicon-link"></span></a>- Tool: <a href="%22http://www.usadellab.org/cms/?page=trimmomatic%22">Trimmomatic</a> 이용</h4>
<hr>
<ul data-source-line="140">
<li>우리는 1. 단계에서 raw data 상태를 확인만 해본 것이지, 아직 어떤 QC 도 진행하지 않았습니다.</li>
<li>이제 Adapter 시퀀스 제거 및 low quality 시퀀스를 제거해보겠습니다.</li>
<li>작업폴더 (KOGO_workshop)로 이동</li>
</ul>
<pre><code class="hljs"><span class="hljs-built_in">cd</span> /mnt/c/Users/윈도우사용자계정/Desktop/KOGO_winter</code></pre><ul data-source-line="147">
<li>Trimmomatic 을 이용하여 QC 진행</li>
</ul>
<pre><code class="hljs">java -jar ./Win_tools/Trimmomatic-0.39/trimmomatic-0.39.jar \
   PE \
   ./Inputs/M2_10Krc_1.fastq.gz \
   ./Inputs/M2_10Krc_2.fastq.gz \
   ./my_results/02_M2_TM_R1_paired.fastq \
   ./my_results/02_M2_TM_R1_unpaired.fastq \
   ./my_results/02_M2_TM_R2_paired.fastq \
   ./my_results/02_M2_TM_R2_unpaired.fastq \
   ILLUMINACLIP:./Win_tools/Trimmomatic-0.39/adapters/TruSeq3-PE.fa:2:30:10 \
   LEADING:3 \
   TRAILING:3 \
   SLIDINGWINDOW:4:20 \
   MINLEN:105</code></pre><ul data-source-line="164">
<li>
<p>output 파일 순서 유의</p>
</li>
<li>
<p>ILLUMINACLIP: adapter 제거 옵션</p>
</li>
<li>
<p>LEADING: 5'쪽 triming (Phred score &lt;3 or N)</p>
</li>
<li>
<p>TRAILING: 3'쪽 triming (Phred score &lt;3 or N)</p>
</li>
<li>
<p>SLIDINGWINDOW: 5'쪽부터 4 bases (:4)씩 스캐닝하면서, window 내 평균 quality &lt;20 (:20)이면 clips 하는 trimming 방법</p>
</li>
<li>
<p>MINLEN: read lenghs (150bp 경우) trimming 전후 70% 미만 길이(105bp)이면 제거</p>
</li>
<li>
<p>Trimmomatic 에 대한 자세한 옵션 설명은 <a href="http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf">Trimmomatic manual</a> 참고</p>
</li>
<li>
<p>Trimmomatic 결과 파일</p>
</li>
</ul>
<pre><code>├── My_results
    ├── 02_M2_TM_R1_paired.fastq
    ├── 02_M2_TM_R1_unpaired.fastq
    ├── 02_M2_TM_R2_paired.fastq
    ├── 02_M2_TM_R2_unpaired.fastq
</code></pre>
<ul data-source-line="183">
<li>1차 QC가 끝난 파일을 FastQC를 이용해서 다시 살펴보기</li>
</ul>
<pre><code class="hljs">./Win_tools/FastQC/fastqc \
./my_results/02_M2_TM_R2_paired.fastq \
-o ./my_results/</code></pre><ul data-source-line="189">
<li>FastQC 결과파일</li>
</ul>
<pre><code>├── My_results
    ├── 02_M2_TM_R2_paired_fastqc.html
    ├── 02_M2_TM_R2_paired_fastqc.zip
</code></pre>
<ul data-source-line="195">
<li>
<p>raw data 의 FastQC 결과 파일과 비교해보세요. 무엇이 달라졌나요?</p>
</li>
<li>
<p>8개의 input files 의 Trimmomatic 결과</p>
<ul>
<li>Outputs 폴더 &gt; 02_trimmomatic 폴더에 결과 저장</li>
<li>Finder로 확인하세요.</li>
</ul>
</li>
</ul>
<pre><code class="hljs">├── Outputs
    ├── 01_fastqc
        ├── F1_TM_R1_paired.fastq
        ├── F1_TM_R1_unpaired.fastq
        ├── F1_TM_R2_paired.fastq
        ├── F1_TM_R2_unpaired.fastq
        ├── F2_TM_R1_paired.fastq
        ├── F2_TM_R1_unpaired.fastq
        ├── F2_TM_R2_paired.fastq
        ├── F2_TM_R2_unpaired.fastq
        ├── M1_TM_R1_paired.fastq
        ├── M1_TM_R1_unpaired.fastq
        ├── M1_TM_R2_paired.fastq
        ├── M1_TM_R2_unpaired.fastq
        ├── M2_TM_R1_paired.fastq
        ├── M2_TM_R1_unpaired.fastq
        ├── M2_TM_R2_paired.fastq
        ├── M2_TM_R2_unpaired.fastq</code></pre><br>
<h3 id="3-removal-of-unwanted-reads-human-시퀀스-제거" data-source-line="222"><a class="anchor" href="#3-removal-of-unwanted-reads-human-시퀀스-제거"><span class="octicon octicon-link"></span></a>3. Removal of unwanted reads (Human 시퀀스 제거)</h3>
<h4 id="-tool-bowtie2-와-samtools-이용" data-source-line="223"><a class="anchor" href="#-tool-bowtie2-와-samtools-이용"><span class="octicon octicon-link"></span></a>- Tool: <a href="%22https://bowtie-bio.sourceforge.net/bowtie2/manual.shtml%22">Bowtie2</a> 와 <a href="%22https://samtools.sourceforge.net%22">samtools</a> 이용</h4>
<hr>
<p data-source-line="226">1). QC 가 끝난 cleaned fastq 파일을 human reference genome 에 mapping</p>
<pre><code class="hljs">./Win_tools/bowtie2-2.5.0-linux-x86_64/bowtie2 \
 --very-sensitive-local \
 -p 2 \
 --seed 99 \
 -x ./DB/GRCh38_noalt_as/GRCh38_noalt_as \
 -1 ./my_results/02_M2_TM_R1_paired.fastq \
 -2 ./my_results/02_M2_TM_R2_paired.fastq \
 -S ./my_results/03_M2_mapped_and_unmapped.sam</code></pre><ul data-source-line="237">
<li>결과파일: 03_M2_mapped_and_unmapped.sam
<ul>
<li>human reference genome 에 mapped 된 리드와, unmapped 리드들이 모두 이 하나의 파일에 들어있음</li>
</ul>
</li>
</ul>
<p data-source-line="240">2). SAM 파일을 BAM 파일로 변환</p>
<pre><code class="hljs">./Win_tools/samtools-1.16.1/samtools view \
 -@ 2 \
 -bS ./my_results/03_M2_mapped_and_unmapped.sam \
 &gt; ./my_results/04_M2_mapped_and_unmapped.bam</code></pre><p data-source-line="248">3). Human genome 에 mapped 되지 않은 (Metagenome으로 예상되는) unmapped reads 만 추출</p>
<ul data-source-line="249">
<li>samtools flag 사용: <a href="%22https://broadinstitute.github.io/picard/explain-flags.html%22">SAM flags</a> 설명
<ul>
<li>-f12: Extract (-f) only alignments with both reads unmapped: "read unmapped"/"mate unmapped"</li>
<li>-F256: Do not extract (-F) alignments which are: "not primary alignment"</li>
</ul>
</li>
<li>R1 read 와 R2 read 모두 동시에 unmap 인 reads 만 추출</li>
</ul>
<pre><code class="hljs">./Win_tools/samtools-1.16.1/samtools view \
 -@ 2 \
 -b <span class="hljs-_">-f</span> 12 -F 256 \
 ./my_results/04_M2_mapped_and_unmapped.bam \
 &gt; ./my_results/05_M2.unmapped.bam</code></pre><p data-source-line="261">4). Sort the reads</p>
<pre><code class="hljs">./Win_tools/samtools-1.16.1/samtools sort \
 -@ 2 \
 -n ./my_results/05_M2.unmapped.bam \
 -o ./my_results/06_M2.unmap.sorted.bam</code></pre><p data-source-line="269">5). Sorted reads 를 fastq 포멧으로 변환</p>
<pre><code class="hljs">./Win_tools/samtools-1.16.1/samtools bam2fq \
 -@ 2 \
 ./my_results/06_M2.unmap.sorted.bam \
 &gt; ./my_results/07_M2_metagenome.fastq</code></pre><p data-source-line="277">6). 최종 metagenome.fasq 파일 확인</p>
<pre><code class="hljs">less -S ./my_results/07_M2_metagenome.fastq</code></pre><ul data-source-line="282">
<li>PhiX 시퀀스 제거 역시 위 1)-5) 과정을 한번 더 똑같이 하면 됩니다.</li>
<li>8개의 input files (QCed fastq files) 의 Bowtie2 &amp; Samtools 수행 결과
<ul>
<li>Outputs 폴더 &gt; 03_filter_out_human 폴더에 결과 저장</li>
<li>Finder로 확인하세요.</li>
<li>low quality 시퀀스가 제거되고, host contaminant 도 제거된 메타지놈 시퀀스 파일입니다.</li>
</ul>
</li>
</ul>
<pre><code class="hljs">├── Outputs
    ├── 03_filter_out_human
       ├── F1.unmap.sorted.bam
       ├── F1_mapped_and_unmapped.bam
       ├── F1_mapped_and_unmapped.sam
       ├── F1_metagenome.fastq
       ├── F1.unmapped.bam
       ├── F2_mapped_and_unmapped.bam
       ├── F2_mapped_and_unmapped.sam
       ├── F2_metagenome.fastq
       ├── F2.unmap.sorted.bam
       ├── F2.unmapped.bam
       ├── M1_mapped_and_unmapped.bam
       ├── M1_mapped_and_unmapped.sam
       ├── M1_metagenome.fastq
       ├── M1.unmap.sorted.bam
       ├── M1.unmapped.bam
       ├── M2_mapped_and_unmapped.bam
       ├── M2_mapped_and_unmapped.sam
       ├── M2_metagenome.fastq
       ├── M2.unmap.sorted.bam
       ├── M2.unmapped.bam</code></pre><br>
<hr>
<p data-source-line="314">(옵션) <a href="%22https://huttenhower.sph.harvard.edu/kneaddata/%22">Kneaddata</a> 프로그램을 사용하여, Trimommatic 과 bowtie2 를 한꺼번에 돌릴 수도 있음</p>
<h4 id="-본-실습에서는-진행하지-않겠습니다-필요하신-분들만-워크샵-이후에-참고하세요" data-source-line="315"><a class="anchor" href="#-본-실습에서는-진행하지-않겠습니다-필요하신-분들만-워크샵-이후에-참고하세요"><span class="octicon octicon-link"></span></a>- <code>본 실습에서는 진행하지 않겠습니다.</code> 필요하신 분들만 워크샵 이후에 참고하세요!</h4>
<h6 id="-kneaddata-설치" data-source-line="316"><a class="anchor" href="#-kneaddata-설치"><span class="octicon octicon-link"></span></a>- Kneaddata 설치</h6>
<pre><code class="hljs"><span class="hljs-comment">#pip install kneaddata   #실제 사용할때는 명령어 앞 #지우고 사용</span></code></pre><h6 id="-kneaddata-실행" data-source-line="321"><a class="anchor" href="#-kneaddata-실행"><span class="octicon octicon-link"></span></a>- Kneaddata 실행</h6>
<pre><code class="hljs"><span class="hljs-comment">#kneaddata \</span>
<span class="hljs-comment">#-i ./Inputs/M1_10Krc_1.fastq.gz -i ./Inputs/M1_100Krc_2.fastq.gz \</span>
<span class="hljs-comment">#-db ./DB/GRCh38_noalt_as/GRCh38_noalt_as \</span>
<span class="hljs-comment">#-db ./DB/PhiX_bt/genome \</span>
<span class="hljs-comment">#-o ./Outputs/kneaddata_M1 \</span>
<span class="hljs-comment">#--fastqc ./Mac/FastQC.app/Contents/MacOS/fastqc \</span>
<span class="hljs-comment">#--run-trim-repetitive \</span>
<span class="hljs-comment">#--trimmomatic ./Trimmomatic-0.39 \</span>
<span class="hljs-comment">#--trimmomatic-options="SLIDINGWINDOW:4:20 MINLEN:105" \</span>
<span class="hljs-comment">#--sequencer-source TruSeq3 \</span>
<span class="hljs-comment">#--bypass-trf \</span>
<span class="hljs-comment">#--store-temp-output    #실제 사용할때는 명령어 앞 #지우고 사용</span></code></pre><hr>
<br>
<h1 id="taxonomic-functional-profiling" data-source-line="341"><a class="anchor" href="#taxonomic-functional-profiling"><span class="octicon octicon-link"></span></a>Taxonomic &amp; Functional Profiling</h1>
<h4 id="-tool-humann3-이용" data-source-line="343"><a class="anchor" href="#-tool-humann3-이용"><span class="octicon octicon-link"></span></a>- Tool: <a href="%22https://huttenhower.sph.harvard.edu/humann/%22">HUMAnN3</a> 이용</h4>
<ul data-source-line="344">
<li>HUMAnN은 Functional profiling 을 하기위한 단계 중, Marker gene mapping 단계를 거치기때문에, MetaPhlAn (본 실습에서 사용하는 버전은 <a href="%22https://huttenhower.sph.harvard.edu/metaphlan/%22">MetaPhlAn4</a>) 결과가 중간 과정에서 생성됩니다.</li>
<li>한번의 run 으로 taxonomic &amp; functional profiling 을 동시에 얻을 수 있다는 장점이 있습니다.</li>
</ul>
<hr>
<ul data-source-line="348">
<li>
<p>input 파일에는, fastq, fastq.gz, fasta, fasta.gz 포멧 모두 가능</p>
</li>
<li>
<p>본인의 컴퓨터 사양(CPU)에 따라 가능한 core 수를 <code>--threads</code> 적용하면, 많은 core를 사용할 수록 당연히 분석시간이 짧아집니다.</p>
</li>
<li>
<p>Translated search (DIAMOND)에 사용되는 DB 연구(자,환경)에 따라 여러가지를 선택할 수 있으며, 본 실습에서는 EC-filtered UniRef50 (0.3GB)의 작은 사이즈의 DB를 사용함</p>
<ul>
<li>full UniRef90 (20.7GB. 실제 분석 시 추천)</li>
<li>EC-filtered UniRef90 (0.9GB)</li>
<li>full UniRef50 (6.9GB)</li>
<li><code>humann_databases --download uniref $DB명 $INSTALL_LOCATION</code> 으로 다운로드 후,  <code>protein-database $INSTALL_LOCATION</code> 옵션을 추가하여 사용</li>
<li><code>--bypass-transtated-search</code> 옵션을 사용하여 translated search를 skip 할 수도 있음</li>
</ul>
</li>
<li>
<p>HUMAnN 실행</p>
</li>
</ul>
<pre><code class="hljs">humann \
--input ./Outputs/03_filter_out_human/M1_metagenome.fastq \
--output ./my_results/08_10K_M1_humann \
--threads 2 \
--protein-database ./DB/Humann/uniref</code></pre><ul data-source-line="366">
<li>4명 샘플을 동시에 HUMAnN 실행 방법 <code>(오늘 돌리면 집에 못갑니다 ㅠㅠ 실습시간에는 skip 하세요)</code>
<ul>
<li>샘플 1개씩이 아닌, 폴더내 모든 샘플을 한꺼번에 돌리고 싶을때에는, filtered_fastq 파일들을 모두 한 폴더에 넣고, 해당 폴더명을 input 으로 지정할 수 있음</li>
<li>filtered_fastq 파일들을 QCed_fastq 폴더로 몰아 넣기</li>
</ul>
</li>
</ul>
<pre><code class="hljs"><span class="hljs-comment">#cd ./Outputs/03_filter_out_human/   #실제 사용할때는 명령어 앞 #지우고 사용</span>

<span class="hljs-comment">#mkdir QCed_fastq</span>

<span class="hljs-comment">#mv *.fastq ./QCed_fastq</span>

<span class="hljs-comment">#humann \</span>
<span class="hljs-comment">#--input ./Outputs/03_filter_out_human/QCed_fastq \</span>
<span class="hljs-comment">#--output ./my_results/04_humann_results_all</span></code></pre><h3 id="-humaan-outputs" data-source-line="382"><a class="anchor" href="#-humaan-outputs"><span class="octicon octicon-link"></span></a>- HUMAaN Outputs</h3>
<ul data-source-line="383">
<li>my_results 폴더 &gt; 08_10K_M1_humann 폴더를 Finder 에서 확인하세요.</li>
<li>Outputs 폴더 &gt; 04_taxaNfunc 폴더
<ul>
<li>총 4명 샘플에 대한 HUMaN 결과파일</li>
<li>이 결과는 10만 리드짜리 input files 을 이용하여, full UniRef90 DB 로 translated search된 결과입니다.</li>
</ul>
</li>
<li>Finder로 확인하세요.</li>
</ul>
<pre><code class="hljs">├── Outputs
    ├── 04_taxNfunc
        ├── 100K_M1_humann   
            ├── *_genefamilies.tsv   <span class="hljs-comment"># gene families (Uniref90) 결과 (단위: RPK, reads per kilobase)</span>
            ├── *_pathabundance.tsv   <span class="hljs-comment"># pathways (MetaCyc) 결과 </span>
            ├── *_pathcoverage.tsv
            ├── *_humann_temp
                ├── *_bowtie2_alinged.sam  <span class="hljs-comment"># bwotie2 로 align 한 모든 alignments</span>
                ├── *_bowtie2_aligned.tsv  <span class="hljs-comment"># sam 파일의 작은 버전</span>
                ├── *_bowtie2_index.*.bt2  <span class="hljs-comment"># chochophlan DB 로부터 만들어진 index 파일 (6개)</span>
                ├── *_bowtie2_unaligned.fa  <span class="hljs-comment"># unmapped reads -&gt; translated search (DIAMOND) 에 input 파일로 사용</span>
                ├── *_custom_chocophlan_database.ffn 
                ├── *_diamond_aligned.tsv  <span class="hljs-comment"># DIAMOND (translated alignment step) 실행 후 aglignment 결과</span>
                ├── *_diamond_aligned.fa   <span class="hljs-comment"># DIAMOND 실행 후 unaligned reads</span>
                ├── *_metaphlan_bowtie2.txt  <span class="hljs-comment"># metaphlan 실행 후 bowtie2 결과 -&gt; Metaphlan 을 다른 옵션으로 다시 돌리고 싶을 때 input 으로 사용 가능 </span>
                ├── *_metaphlan_bugs_list.tsv <span class="hljs-comment"># metaphlan 실행후 Taxonomy profiling 결과파일!* (단위: relative abundance, 0-100 range)</span>
                ├── *.log  <span class="hljs-comment"># HUMAnN 실행 로그파일: 각 단계의 분석 소요시간, unaligned reads 의 %, alignment statistics 등 확인 가능</span>
        ├── 100K_M2_humann  
        ├── 100K_F1_humann        
        ├── 100K_F2_humann</code></pre><br>
<h2 id="1-taxonomy-profiling" data-source-line="412"><a class="anchor" href="#1-taxonomy-profiling"><span class="octicon octicon-link"></span></a>1. Taxonomy Profiling</h2>
<h4 id="-metaphlan-결과-확인" data-source-line="414"><a class="anchor" href="#-metaphlan-결과-확인"><span class="octicon octicon-link"></span></a>- MetaPhlAn 결과 확인</h4>
<ul data-source-line="415">
<li>작업폴더 (KOGO_workshop)로 이동</li>
</ul>
<pre><code class="hljs"><span class="hljs-built_in">cd</span> /mnt/c/Users/윈도우사용자계정/Desktop/KOGO_winter</code></pre><pre><code class="hljs">less -S ./Outputs/04_taxaNfunc/100K_F1_humann/F1_metagenome_humann_temp/F1_metagenome_metaphlan_bugs_list.tsv   <span class="hljs-comment"># 확인했으면 q 를 누르고 빠져나오세요</span></code></pre><h4 id="-metaphlan-profile-합치기" data-source-line="425"><a class="anchor" href="#-metaphlan-profile-합치기"><span class="octicon octicon-link"></span></a>- MetaPhlAn profile 합치기</h4>
<pre><code class="hljs">merge_metaphlan_tables.py \
./Outputs/05_taxonomy/*_metagenome_metaphlan_bugs_list.tsv \
&gt; ./my_results/09_merged_taxa_table.txt</code></pre><pre><code class="hljs">less -S ./my_results/09_merged_taxa_table.txt</code></pre><h4 id="-taxonomic-profiles-로-heatmap-그리기" data-source-line="435"><a class="anchor" href="#-taxonomic-profiles-로-heatmap-그리기"><span class="octicon octicon-link"></span></a>- Taxonomic profiles 로 Heatmap 그리기</h4>
<ul data-source-line="436">
<li>Species abundance 만 추출하기</li>
</ul>
<pre><code class="hljs">grep -E <span class="hljs-string">"s__|clade"</span> ./Outputs/05_taxonomy/merged_taxa_table.txt \
| grep -v <span class="hljs-string">"t__"</span> \
| sed <span class="hljs-string">"s/^.*|//g"</span> \
| sed <span class="hljs-string">"s/clade_name/male_female/g"</span> \
| sed <span class="hljs-string">"s/_metagenome_metaphlan_bugs_list//g"</span> \
&gt; ./my_results/10_merged_taxa_table_species.txt</code></pre><pre><code class="hljs">less -S ./my_results/10_merged_taxa_table_species.txt</code></pre><ul data-source-line="449">
<li>hclust2.py 실행</li>
<li>species level 만 그려보기 (top 10)</li>
</ul>
<pre><code class="hljs">hclust2.py \
-i ./Outputs/05_taxonomy/merged_taxa_table_species.txt \
-o ./my_results/11_metaphlan4_heatmap_species.png \
--f_dist_f braycurtis \
--s_dist_f braycurtis \
--cell_aspect_ratio 0.5 \
--log_scale \
--ftop 10 \
--flabel_size 10 --slabel_size 10 \
--max_flabel_len 100 --max_slabel_len 100 \
--dpi 300</code></pre><ul data-source-line="464">
<li>모든 taxa level에 대해서 그려보기 (top 10)</li>
</ul>
<pre><code class="hljs">hclust2.py \
-i ./Outputs/05_taxonomy/merged_taxa_table.txt \
-o ./my_results/12_metaphlan4_heatmap_alltaxa.png \
--f_dist_f braycurtis \
--s_dist_f braycurtis \
--cell_aspect_ratio 0.5 \
--log_scale \
--ftop 10 \
--flabel_size 10 --slabel_size 10 \
--max_flabel_len 100 --max_slabel_len 100 \
--dpi 300</code></pre><ul data-source-line="479">
<li>plotting 에 대한 기타 상세옵션은 python hclust2.py --help 에서 확인가능</li>
<li><a href="%22https://huttenhower.sph.harvard.edu/maaslin2/maaslin%22">MaAsLin</a> 같은 통계분석 툴을 이용하여 보다 정확한 통계분석 가능</li>
</ul>
<ul data-source-line="482">
<li>(옵션) SGB profiles 을 Genome Taxonomy database (<a href="%22https://gtdb.ecogenomic.org%22">GTDB</a>) taxonomy 로 바꾸기</li>
</ul>
<pre><code class="hljs">sgb_to_gtdb_profile.py -i <span class="hljs-variable">$metaphlan_output</span> -o <span class="hljs-variable">$GTDB_output</span></code></pre> <br>
<h2 id="2-functional-profiling" data-source-line="490"><a class="anchor" href="#2-functional-profiling"><span class="octicon octicon-link"></span></a>2. Functional Profiling</h2>
<pre><code class="hljs">├── Outputs
    ├── 04_taxaNfunc
        ├── 100K_M1_humann   
            ├── *_genefamilies.tsv   <span class="hljs-comment"># gene families (Uniref90) 결과 (단위: RPK, reads per kilobase)</span>
            ├── *_pathabundance.tsv   <span class="hljs-comment"># pathways (MetaCyc) 결과 (단위: </span>
            ├── *_pathcoverage.tsv</code></pre><ul data-source-line="499">
<li>각 output 의 보다 상세한 설명은 <a href="%22https://github.com/biobakery/humann%22">HUMAnN 튜토리얼</a> 참고</li>
<li>Gene famlies: Groups of evolutionarily-related protein-coding sequences that often perform similar functions.</li>
<li>Pathway abundance: Abundances of the pathway's component reactions with each reaction's abundance computed as the sum over abundances of genes catalyzing the reaction.
<ul>
<li>Pathway abundance is proportional to the number of complete "copies" of the pathway in the community. Thus, for a simple linear pathway RXN1 + RXN2 + RXN3 + RXN4, if RXN1 is 10 times as abundant as RXNs 2-4, the pathway abundance will be driven by the abundances of RXNs 2-4.</li>
<li>Unlike gene abundance, a pathway's community-level abundance is not necessarily the sum of its stratified abundance values. For example, continuing with the simple linear pathway example introduced above, if the abundances of RXNs 1-4 are [5, 5, 10, 10] in Species_A and [10, 10, 5, 5] in Species_B, HUMAnN 3.0 would report that Species_A and Species_B each contribute 5 complete copies of the pathway. However, at the community level, the reaction totals are [15, 15, 15, 15], and thus HUMAnN 3.0 would report 15 complete copies.</li>
</ul>
</li>
<li>Pathway coverage: Alternative description of the presence (1) and absence (0) of pathways in a community, independent of their quantitative abundance. A confidence score to each reaction detected in the community (1= confidently detected pathway, 0=less confidently detected).</li>
</ul>
<br>
<h4 id="-normalization-of-output-files" data-source-line="508"><a class="anchor" href="#-normalization-of-output-files"><span class="octicon octicon-link"></span></a>- Normalization of output files</h4>
<ul data-source-line="509">
<li>작업폴더 (KOGO_workshop)로 현재위치 이동</li>
</ul>
<pre><code class="hljs"><span class="hljs-built_in">cd</span> /mnt/c/Users/윈도우사용자계정/Desktop/KOGO_winter</code></pre><ul data-source-line="513">
<li>genefamilies 파일 결과 확인해보기</li>
</ul>
<pre><code class="hljs">less -S ./Outputs/04_taxaNfunc/100K_M1_humann/M1_metagenome_genefamilies.tsv</code></pre><pre><code class="hljs">humann_renorm_table \
--input ./Outputs/04_taxaNfunc/100K_M1_humann/M1_metagenome_genefamilies.tsv \
--output ./my_results/13_M1_genefamilies_relab.tsv \
--units relab</code></pre><ul data-source-line="524">
<li>renomalized genefamilies 파일 결과 확인해보기</li>
</ul>
<pre><code class="hljs">less -S ./my_results/13_M1_genefamilies_relab.tsv</code></pre><br>
<h4 id="-여러명의-individual-샘플-결과를-하나의-파일로-합치기" data-source-line="532"><a class="anchor" href="#-여러명의-individual-샘플-결과를-하나의-파일로-합치기"><span class="octicon octicon-link"></span></a>- 여러명의 Individual 샘플 결과를 하나의 파일로 합치기</h4>
<ol data-source-line="533">
<li>Gene families</li>
</ol>
<pre><code class="hljs">humann_join_tables \
--input ./Outputs/06_humann_renorm/genefam_relab \
--output ./my_results/14_humann_genefamilies_relab_merged.tsv \
--file_name genefamilies_relab</code></pre><pre><code class="hljs">less -S ./my_results/14_humann_genefamilies_relab_merged.tsv</code></pre><ol start="2" data-source-line="544">
<li>Pathways coverage</li>
</ol>
<pre><code class="hljs">humann_join_tables \
--input ./Outputs/06_humann_renorm/pathcov \
--output ./my_results/15_humann_pathcoverage_merged.tsv \
--file_name pathcoverage</code></pre><pre><code class="hljs">less -S ./my_results/15_humann_pathcoverage_merged.tsv</code></pre><ol start="3" data-source-line="555">
<li>Pathway abundance</li>
</ol>
<pre><code class="hljs">humann_join_tables \
--input ./Outputs/06_humann_renorm/pathabun_relab \
--output ./my_results/16_humann_pathabundance_relab_merged.tsv \
--file_name pathabun_relab</code></pre><pre><code class="hljs">less -S ./my_results/16_humann_pathabundance_relab_merged.tsv</code></pre><br>
<h4 id="-file-split-stratified-and-unstratified-table-생성" data-source-line="569"><a class="anchor" href="#-file-split-stratified-and-unstratified-table-생성"><span class="octicon octicon-link"></span></a>- File split: stratified and unstratified table 생성</h4>
<ul data-source-line="570">
<li>Gene families 나 Pathway abundance 에 contribute 하는 taxa 정보를 포함/제외 하는 명령어</li>
</ul>
<ol data-source-line="571">
<li>Gene families</li>
</ol>
<pre><code class="hljs">humann_split_stratified_table \
--input ./Outputs/06_humann_renorm/humann_genefamilies_relab_merged.tsv \
--output ./my_results/17_genefam_split</code></pre><ol start="2" data-source-line="577">
<li>Pathways coverage</li>
</ol>
<pre><code class="hljs">humann_split_stratified_table \
--input ./Outputs/06_humann_renorm/humann_pathcoverage_merged.tsv \
--output ./my_results/18_pathcov_split</code></pre><ol start="3" data-source-line="583">
<li>Pathway abundance</li>
</ol>
<pre><code class="hljs">humann_split_stratified_table \
--input ./Outputs/06_humann_renorm/humann_pathabundance_relab_merged.tsv \
--output ./my_results/19_pathabun_split</code></pre><ul data-source-line="592">
<li>이렇게 합쳐진 파일은 <a href="%22https://huttenhower.sph.harvard.edu/maaslin2/maaslin%22">MaAsLin</a> 같은 통계분석 툴의 input file 로 사용 가능</li>
</ul>
<br>
<h3 id="-downstream-analysis" data-source-line="597"><a class="anchor" href="#-downstream-analysis"><span class="octicon octicon-link"></span></a>- Downstream analysis</h3>
<ul data-source-line="598">
<li>관심있는 phenotype 과 metagenome 에 대한 association 분석을 하기위해서는, 마이크로바이옴데이터에 특화되어 있는 다양한 통계 툴 이용가능
<ul>
<li><a href="%22https://huttenhower.sph.harvard.edu/maaslin/%22">MaAsLin</a></li>
<li><a href="%22https://github.com/FrederickHuangLin/ANCOM-Code-Archive%22">ANCOM</a></li>
<li><a href="%22https://huttenhower.sph.harvard.edu/halla/%22">HAllA</a></li>
<li><a href="%22https://github.com/ggloor/ALDEx2_dev%22">ALDEX</a></li>
</ul>
</li>
<li>HUMAnN 에서도 Kruskal-Wallis analysis 정도의 간단한 분석은 가능함</li>
<li>phenotype 데이터와 메타지놈 데이터를 통합한 pcl 파일을 만들어서 이용</li>
</ul>
<pre><code class="hljs">less -S ./Outputs/06_humann_renorm/sex_pathabund.pcl</code></pre><pre><code class="hljs">humann_associate --input ./Outputs/06_humann_renorm/sex_pathabund.pcl \
--last-metadatum sex \
--focal-metadatum sex \
--focal-type categorical \
--output ./my_results/20_sex_path_stats.txt \
--fdr 1</code></pre><ul data-source-line="616">
<li>위 명령어 실행 후, <code>humann_associate: command not found</code> 로 에러가 날 수도 있습니다.</li>
<li>이는 humann_associate 모듈이 설치가 안된 것인데, Mac (intel) 에서는 문제없이 설치되나, Linux (Window에서 WSL) 또는 Mac (M1 chip)에서 설치가 안될 수 있는 것 같습니다.</li>
<li>HUMAnN에서의 association분석은 DEMO 용이라고 HUMAnN 팀에서도 위 언급한 association 전용툴을 추천하고 있으니, 이 명령어에 에러가 나신 분들은, 실행은 스킵하고, <code>./Outputs/06_humann_renorm/sex_path_stats.txt</code> 이 결과파일만 어떻게 생겼는지 참고하시기 바랍니다.</li>
</ul>
<br>
<h3 id="-humann-bar-plot-그리기" data-source-line="622"><a class="anchor" href="#-humann-bar-plot-그리기"><span class="octicon octicon-link"></span></a>- HUMAnN bar plot 그리기</h3>
<pre><code class="hljs">humann_barplot \
--input ./Outputs/06_humann_renorm/sex_pathabund.pcl \
--last-metadata sex \
--focal-feature PWY-7221 \
--focal-metadata sex \
--sort none \
--exclude-unclassified \
--output ./my_results/21_humann_barplot_PWY-7221</code></pre><ul data-source-line="633">
<li>sort: none, sum, dominant, braycurtis, braycurtis_m, metadata 중 선택 가능</li>
<li>plotting 에 대한 기타 상세옵션은 humann_barplot --help 에서 확인가능</li>
</ul>
<p data-source-line="636"><br><br></p>
<h2 id="수고하셨습니다-br" data-source-line="638"><a class="anchor" href="#수고하셨습니다-br"><span class="octicon octicon-link"></span></a>수고하셨습니다! <br></h2>
<h3 id="본-스크립트는-잘-보관하셔서-차후-metagenomics-분석하실-때-요긴하게-사용하시길-바랍니다~poopbugsweat_smilegrinheart" data-source-line="639"><a class="anchor" href="#본-스크립트는-잘-보관하셔서-차후-metagenomics-분석하실-때-요긴하게-사용하시길-바랍니다~poopbugsweat_smilegrinheart"><span class="octicon octicon-link"></span></a>본 스크립트는 잘 보관하셔서 차후 Metagenomics 분석하실 때 요긴하게 사용하시길 바랍니다~<i class="e1a-poop"></i><i class="e1a-bug"></i><i class="e1a-sweat_smile"></i><i class="e1a-grin"></i><i class="e1a-heart"></i></h3>
<hr>
<p data-source-line="642">강의자료 제작: <span style="color:blue">성균관대학교 삼성융합의과학원/강북삼성병원 <strong>김한나</strong></span> (문의: <a href="mailto:147942@hanmail.net">147942@hanmail.net</a>)</p>
<hr>
</article><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.slim.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js"></script><script>$(function() { $('canvas.chartjs').each(function() { new Chart($(this), JSON.parse($(this).text())); }); });</script></body></html>